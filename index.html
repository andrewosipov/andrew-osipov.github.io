<!doctype html>
<head>
    <link href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css" rel="stylesheet">
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>

    <script src="tinymce/tinymce.min.js"></script>

    <style type="text/css">
        .tox-dialog {
            /* The advcode dialog was too tall and being clipped */
            max-height: calc(100% - 5px) !important;
        }
        body {
            border: 1px;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        div#editor {
            width:100%;
            min-height:550px;
            max-height: 700px;
        }
    </style>
</head>
<body>
<div id="editor"></div>
<script>
    window.contentfulExtension.init(function (api) {
        var currentValue;
        api.window.startAutoResizer();
        const editor = tinymce.init({
            selector: '#editor',
            max_height: 700,
            min_height: 500,
            plugins: "autoresize textpattern lists advlist media link autolink code importcss table",
            toolbar: "undo redo | formatselect | bold italic | alignleft aligncenter alignright alignjustify | numlist bullist outdent indent | link | table | code",
            menubar: "edit view insert format table",
            contextmenu: "link image imagetools table spellchecker",
            link_class_list: [
                {title: 'None', value: ''},
                {title: 'Button', value: 'button'},
                {title: 'Button green', value: 'button button__green'}
            ],
            preview_styles: "font-family font-size font-weight font-style text-decoration text-transform color background-color border border-radius outline text-shadow padding margin",
            content_css: "/styles/styles.css",
            // quickbars_insert_toolbar: 'quickimage quicktable',
            init_instance_callback : function(editor) {
                var listening = true;

                function getEditorContent() {
                    return editor.getContent() || '';
                }

                function getApiContent() {
                    return api.field.getValue() || '';
                }

                function setContent(x) {
                    var apiContent = x || '';
                    var editorContent = getEditorContent();
                    if (apiContent !== editorContent) {
                        editor.setContent(apiContent);
                    }
                }

                setContent(api.field.getValue());

                api.field.onValueChanged(function(x) {
                    if (listening) {
                        setContent(x);
                    }
                });

                function onEditorChange() {
                    var editorContent = getEditorContent();
                    var apiContent = getApiContent();

                    if (editorContent !== apiContent) {
                        //console.log('Setting content in api to: [' + editorContent + ']');
                        listening = false;
                        api.field.setValue(editorContent).then(function() {
                            listening = true;
                        }).catch(function(err) {
                            console.log("Error setting content", err);
                            listening = true;
                        });
                    }
                }

                // var throttled = _.throttle(onEditorChange, 500, {leading: true});
                editor.on('change keyup setcontent blur', onEditorChange);
            }
        });
    })
</script>
</body>
