<!doctype html>
<head>
    <link href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css" rel="stylesheet">
    <link href="https://contentful.github.io/extensions/libs/alloy-editor/assets/alloy-editor-ocean-min.css" rel="stylesheet">
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
    <script src="https://cloud.tinymce.com/5/tinymce.min.js?apiKey=js97znaih26wzyzawqgycxbli9ohhou7abq6z31pmk9b2uvn" sandbox="allow-same-origin allow-scripts"></script>
    <style type="text/css">
        .tox-dialog {
            /* The advcode dialog was too tall and being clipped */
            max-height: calc(100% - 5px) !important;
        }
        body {
            border: 1px;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        div#editor {
            width:100%;
            min-height:250px;
        }
    </style>
</head>
<body>
<div id="editor"></div>
<script>
    /*window.contentfulExtension.init(function (ext) {
        var currentValue
        ext.window.startAutoResizer()
        const editor = tinymce
        editor.init({
            selector: "#editor",
            // plugins: [ 'quickbars' ],
            toolbar: false,
            menubar: false,
            inline: true
        });

        editor.setData(ext.field.getValue())
        ext.field.onValueChanged(function(value) {
            if (value !== currentValue) {
                currentValue = value
                editor.setData(value)
            }
        })
        editor.on('change', function() {
            const value = editor.getData()
            if (currentValue !== value) {
                currentValue = value
                ext.field.setValue(value)
            }
        })
    })*/

    window.contentfulExtension.init(function(api) {
        function tinymceForContentful(api) {
            api.window.startAutoResizer();

            function tweak(param) {
                var t = param.trim();
                if (t === "false") {
                    return false;
                } else if (t === "") {
                    return undefined;
                } else {
                    return t;
                }
            }

            var tb = tweak(api.parameters.instance.toolbar);
            var mb = tweak(api.parameters.instance.menubar);

            tinymce.init({
                selector: "#editor",
                plugins: api.parameters.instance.plugins,
                // toolbar: tb,
                // menubar: mb,
                max_height: 500,
                min_height: 300,
                autoresize_bottom_margin: 15,
                resize: false,
                init_instance_callback : function(editor) {
                    var listening = true;

                    function getEditorContent() {
                        return editor.getContent() || '';
                    }

                    function getApiContent() {
                        return api.field.getValue() || '';
                    }

                    function setContent(x) {
                        var apiContent = x || '';
                        var editorContent = getEditorContent();
                        if (apiContent !== editorContent) {
                            //console.log('Setting editor content to: [' + apiContent + ']');
                            editor.setContent(apiContent);
                        }
                    }

                    setContent(api.field.getValue());

                    api.field.onValueChanged(function(x) {
                        if (listening) {
                            setContent(x);
                        }
                    });

                    function onEditorChange() {
                        var editorContent = getEditorContent();
                        var apiContent = getApiContent();

                        if (editorContent !== apiContent) {
                            //console.log('Setting content in api to: [' + editorContent + ']');
                            listening = false;
                            api.field.setValue(editorContent).then(function() {
                                listening = true;
                            }).catch(function(err) {
                                console.log("Error setting content", err);
                                listening = true;
                            });
                        }
                    }

                    var throttled = _.throttle(onEditorChange, 500, {leading: true});
                    editor.on('change keyup setcontent blur', throttled);
                }
            });
        }

        function loadScript(src, onload) {
            var script = document.createElement('script');
            script.setAttribute('src', src);
            script.onload = onload;
            document.body.appendChild(script);
        }

        var sub = location.host == "contentful.staging.tiny.cloud" ? "cloud-staging" : "cloud";
        var apiKey = "js97znaih26wzyzawqgycxbli9ohhou7abq6z31pmk9b2uvn" // api.parameters.installation.apiKey;
        var channel = "5" // api.parameters.installation.channel;
        var tinymceUrl = "https://" + sub + ".tinymce.com/" + channel + "/tinymce.min.js?apiKey=" + apiKey;

        /* loadScript(tinymceUrl, function() {
            tinymceForContentful(api);
        }); */
    });


</script>
</body>
